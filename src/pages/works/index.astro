---
import { WORKS_LIMIT } from "@/constants";
import Layout from "@/layouts/Layout.astro";
import Pagination from "@/components/Pagination.astro";
import PageSection from "@/components/PageSection.astro";
import WorksList from "@/components/WorksList.astro";
import CategoryFilter from "@/components/CategoryFilter.astro";
import type { CategoryList } from "@/types/microcms";

import {
  getWorksList,
  getAllCategoryList,
  getAllWorksList,
} from "@/libs/api/microcms";

const pageTitle = "Works";
const description = "Kaze Notesの作品一覧です。自主制作や学習用として作成した作品を紹介しています。";
const pageNumber = Number(Astro.params.page) || 1;
const { contents: worksList, totalCount } = await getWorksList({
  limit: WORKS_LIMIT,
  offset: (pageNumber - 1) * WORKS_LIMIT,
});
const allWorksList = await getAllWorksList();
const categoryList = await getAllCategoryList({
  filters: "connection[contains]works",
});

const filteredCategoryList: CategoryList = categoryList.filter((category) => {
  return allWorksList.some(
    (works) => works.category.category_id === category.category_id,
  );
});
---

<Layout pageTitle={pageTitle} description={description}>
  <PageSection pageTitle={pageTitle}>
    <CategoryFilter categoryList={filteredCategoryList} currentCategory="all" parentPath="/works" basePath="/works/category"/>
    <WorksList worksList={worksList} />
    <Pagination limit={WORKS_LIMIT} totalCount={totalCount} page={pageNumber} basePath="/works" />
  </PageSection>
</Layout>
